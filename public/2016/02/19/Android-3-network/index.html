

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="做Android开发已经有两年了，这两年来自己有收获，也有很多的挫折。自己是属于比较笨的那种人，所以，我想现在就开始试着把自己之前学过的东西总结一下，那么今天就开始搞一下网络请求的内容。">
<meta property="og:type" content="article">
<meta property="og:title" content="重拾android路(三) 网络请求">
<meta property="og:url" content="http://example.com/2016/02/19/Android-3-network/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="做Android开发已经有两年了，这两年来自己有收获，也有很多的挫折。自己是属于比较笨的那种人，所以，我想现在就开始试着把自己之前学过的东西总结一下，那么今天就开始搞一下网络请求的内容。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2016-02-19T11:57:43.000Z">
<meta property="article:modified_time" content="2023-06-04T11:59:43.075Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="android">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>重拾android路(三) 网络请求 - Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="重拾android路(三) 网络请求"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2016-02-19 19:57" pubdate>
          2016年2月19日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          25k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          207 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">重拾android路(三) 网络请求</h1>
            
            
              <div class="markdown-body">
                
                <p>做Android开发已经有两年了，这两年来自己有收获，也有很多的挫折。自己是属于比较笨的那种人，所以，我想现在就开始试着把自己之前学过的东西总结一下，那么今天就开始搞一下网络请求的内容。</p>
<span id="more"></span>
<p>先说一下，我从2015年开始做Android开发，先后经历过几个网络框架</p>
<ol>
<li>Android-sync-http</li>
<li>volley</li>
<li>OkHttp</li>
<li>Retrofit(2017年补充)</li>
</ol>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>网络请求在现在的开发中越来越常见，我在今年年初的几家面试中，也多次被问到一些关于网络请求框架使用的情况。基本上我们在开发过程中所用的框架，每个公司都有在用的。那么我们有必要说一下，为什么要使用网络框架</p>
<h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><p>网络请求框架是将网络请求的相关功能封装成类库，并且对外提供API</p>
<blockquote>
<p>在没有使用网络框架之前，Android开发中的网络请求是非常繁琐的，因为在Android中主线程不能去请求网络，只能自己去声明一个子线程，完成请求，在得到数据之后，在返回到主线程，然后让主线程去刷新UI，当时用到最多的就是Handler，这个也是非常好用的内容，当时确实帮了很大的忙，以后再说。。。</p>
</blockquote>
<p>在我们使用网络请求之后，对于一些重复的，繁琐的操作不用我们一个个的去写，需要使用的时候，直接调用即可，所以可以大大提高我们的工作效率。</p>
<blockquote>
<p>在使用这些工具之前，最好有一定的网络基础，对于我这个大三的时候挂了计算机网络的人来说，真的是好难，不过后面我也会把这个网络的相关知识总结一下。。。</p>
</blockquote>
<h1 id="网络请求开源库介绍"><a href="#网络请求开源库介绍" class="headerlink" title="网络请求开源库介绍"></a>网络请求开源库介绍</h1><p><a href="/assets/android/android-network-framework01.png">网络请求框架介绍</a></p>
<p>即目前的情况来说，前面两个的使用率已经下降的非常快了，而后面两个的使用率还是非常高的，所以我们把重点放在最后两个部分</p>
<h1 id="OkHttp简介和引入方式"><a href="#OkHttp简介和引入方式" class="headerlink" title="OkHttp简介和引入方式"></a>OkHttp简介和引入方式</h1><p>OkHttp是目前较为流行的网络请求库，特点如下</p>
<ol>
<li>支持http2，对一台机器的所有请求共享同一个socket</li>
<li>内置连接池，支持连接复用，减少延迟</li>
<li>支持透明的gzip压缩响应体</li>
<li>通过缓存避免重复的请求 </li>
<li>请求失败时自动重试主机的其他ip，自动重定向</li>
<li>灵活的拦截器，行为类似Java EE的Filter或者函数编程中的Map</li>
</ol>
<p>配置OkHttp非常简单</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">compile</span> &#x27;com.squareup.okhttp3:okhttp:<span class="hljs-number">3</span>.<span class="hljs-number">4</span>.<span class="hljs-number">1</span>&#x27;<br><span class="hljs-attribute">compile</span> &#x27;com.squareup.okio:okio:<span class="hljs-number">1</span>.<span class="hljs-number">6</span>.<span class="hljs-number">0</span>&#x27;<br></code></pre></td></tr></table></figure>
<p>添加网络权限</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">&lt;uses-permission android:<span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;android.permission.INTERNET&quot;</span>/&gt;<br></code></pre></td></tr></table></figure>
<p>一个非常简单的例子</p>
<figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs vbscript"><span class="hljs-keyword">public</span> void requestB<span class="hljs-built_in">log</span>() &#123;<br>     String url = <span class="hljs-string">&quot;https://api.douban.com/v2/movie/in_theaters&quot;</span>;<br>     mHttpClient = <span class="hljs-keyword">new</span> OkHttpClient();<br>     <span class="hljs-built_in">Request</span> <span class="hljs-built_in">request</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Request</span>.Builder().url(url).build();<br>         /* okhttp3.<span class="hljs-built_in">Response</span> <span class="hljs-built_in">response</span> = <span class="hljs-literal">null</span>;*/<br><br>         /*<span class="hljs-built_in">response</span> = mHttpClient.newCall(<span class="hljs-built_in">request</span>).<span class="hljs-keyword">execute</span>();*/<br>     mHttpClient.newCall(<span class="hljs-built_in">request</span>).enqueue(<span class="hljs-keyword">new</span> Callback() &#123;<br>         @Override<br>         <span class="hljs-keyword">public</span> void onFailure(<span class="hljs-keyword">Call</span> <span class="hljs-keyword">call</span>, IOException e) &#123;<br><br>         &#125;<br><br>         @Override<br>         <span class="hljs-keyword">public</span> void onResponse(<span class="hljs-keyword">Call</span> <span class="hljs-keyword">call</span>, <span class="hljs-built_in">Response</span> <span class="hljs-built_in">response</span>) throws IOException &#123;<br>             String json = <span class="hljs-built_in">response</span>.body().<span class="hljs-built_in">string</span>();<br>             Log.d(<span class="hljs-string">&quot;okHttp&quot;</span>, json);<br>         &#125;<br>     &#125;);<br> &#125;<br></code></pre></td></tr></table></figure>
<h2 id="OkHttp的post请求"><a href="#OkHttp的post请求" class="headerlink" title="OkHttp的post请求"></a>OkHttp的post请求</h2><h3 id="post请求提交json数据"><a href="#post请求提交json数据" class="headerlink" title="post请求提交json数据"></a>post请求提交json数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postJson</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;https://api.douban.com/v2/movie/in_theaters&quot;</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;haha&quot;</span>;<br><br>    <span class="hljs-type">OkHttpClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OkHttpClient</span>();<br><br>    <span class="hljs-type">RequestBody</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> RequestBody.create(JSON, json);<br>    <span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>.Builder()<br>            .url(url)<br>            .post(body)<br>            .build();<br>    client.newCall(request).enqueue(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Callback</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFailure</span><span class="hljs-params">(Call call, IOException e)</span> &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResponse</span><span class="hljs-params">(Call call, Response response)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><br>            Log.d(TAG, response.body().string());<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="post请求提交键值对"><a href="#post请求提交键值对" class="headerlink" title="post请求提交键值对"></a>post请求提交键值对</h3><p>有时候我们需要吧键值对通过post请求提交给服务器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">post</span><span class="hljs-params">(String url, String json)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>     <span class="hljs-type">OkHttpClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OkHttpClient</span>();<br>     <span class="hljs-type">RequestBody</span> <span class="hljs-variable">formBody</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormBody</span>.Builder()<br>             .add(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;liming&quot;</span>)<br>             .add(<span class="hljs-string">&quot;school&quot;</span>, <span class="hljs-string">&quot;beida&quot;</span>)<br>             .build();<br><br>     <span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>.Builder()<br>             .url(url)<br>             .post(formBody)<br>             .build();<br><br>     <span class="hljs-type">Call</span> <span class="hljs-variable">call</span> <span class="hljs-operator">=</span> client.newCall(request);<br>     call.enqueue(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Callback</span>() &#123;<br>         <span class="hljs-meta">@Override</span><br>         <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFailure</span><span class="hljs-params">(Call call, IOException e)</span> &#123;<br><br>         &#125;<br><br>         <span class="hljs-meta">@Override</span><br>         <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResponse</span><span class="hljs-params">(Call call, Response response)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>             <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> response.body().string();<br>             Log.i(TAG, str);<br><br>         &#125;<br><br>     &#125;);<br> &#125;<br></code></pre></td></tr></table></figure>
<h3 id="异步上传文件"><a href="#异步上传文件" class="headerlink" title="异步上传文件"></a>异步上传文件</h3><p>上传文件本身也是一个post请求</p>
<ul>
<li>定义上传文件类型<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">MediaType</span> <span class="hljs-variable">MEDIA_TYPE_MARKDOWN</span><br>        <span class="hljs-operator">=</span> MediaType.parse(<span class="hljs-string">&quot;text/x-markdown; charset=utf-8&quot;</span>);<br></code></pre></td></tr></table></figure></li>
<li>将文件上传到服务器<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">private</span> void post<span class="hljs-constructor">File()</span> &#123;<br>    OkHttpClient mOkHttpClient = <span class="hljs-keyword">new</span> <span class="hljs-constructor">OkHttpClient()</span>;<br>    File file = <span class="hljs-keyword">new</span> <span class="hljs-constructor">File(<span class="hljs-string">&quot;/sdcard/demo.txt&quot;</span>)</span>;<br>    Request request = <span class="hljs-keyword">new</span> Request.<span class="hljs-constructor">Builder()</span><br>            .url(<span class="hljs-string">&quot;https://api.github.com/markdown/raw&quot;</span>)<br>            .post(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">RequestBody</span>.</span></span>create(MEDIA_TYPE_MARKDOWN, file))<br>            .build<span class="hljs-literal">()</span>;<br><br>    mOkHttpClient.<span class="hljs-keyword">new</span><span class="hljs-constructor">Call(<span class="hljs-params">request</span>)</span>.enqueue(<span class="hljs-keyword">new</span> <span class="hljs-constructor">Callback()</span> &#123;<br>        @Override<br>        public void on<span class="hljs-constructor">Failure(Call <span class="hljs-params">call</span>, IOException <span class="hljs-params">e</span>)</span> &#123;<br><br>        &#125;<br><br>        @Override<br>        public void on<span class="hljs-constructor">Response(Call <span class="hljs-params">call</span>, Response <span class="hljs-params">response</span>)</span> throws IOException &#123;<br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Log</span>.</span></span>i(TAG, response.body<span class="hljs-literal">()</span>.<span class="hljs-built_in">string</span><span class="hljs-literal">()</span>);<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>
同时要添加权限<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">&lt;uses-permission android:<span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;android.permission.READ_EXTERNAL_STORAGE&quot;</span>/&gt;<br>&lt;uses-permission android:<span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span>/&gt;<br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="提取响应头"><a href="#提取响应头" class="headerlink" title="提取响应头"></a>提取响应头</h3><p>典型的HTTP头像一个map</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">private</span> final OkHttpClient client = <span class="hljs-keyword">new</span> <span class="hljs-constructor">OkHttpClient()</span>;<br><br>public void run<span class="hljs-literal">()</span> throws Exception &#123;<br>    Request request = <span class="hljs-keyword">new</span> Request.<span class="hljs-constructor">Builder()</span><br>            .url(<span class="hljs-string">&quot;https://api.github.com/repos/square/okhttp/issues&quot;</span>)<br>            .header(<span class="hljs-string">&quot;User-Agent&quot;</span>, <span class="hljs-string">&quot;OkHttp Headers.java&quot;</span>)<br>            .add<span class="hljs-constructor">Header(<span class="hljs-string">&quot;Accept&quot;</span>, <span class="hljs-string">&quot;application/json; q=0.5&quot;</span>)</span><br>            .add<span class="hljs-constructor">Header(<span class="hljs-string">&quot;Accept&quot;</span>, <span class="hljs-string">&quot;application/vnd.github.v3+json&quot;</span>)</span><br>            .build<span class="hljs-literal">()</span>;<br><br>    Response response = client.<span class="hljs-keyword">new</span><span class="hljs-constructor">Call(<span class="hljs-params">request</span>)</span>.execute<span class="hljs-literal">()</span>;<br>    <span class="hljs-keyword">if</span> (!response.is<span class="hljs-constructor">Successful()</span>) throw <span class="hljs-keyword">new</span> <span class="hljs-constructor">IOException(<span class="hljs-string">&quot;Unexpected code &quot;</span> + <span class="hljs-params">response</span>)</span>;<br><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>out.println(<span class="hljs-string">&quot;Server: &quot;</span> + response.header(<span class="hljs-string">&quot;Server&quot;</span>));<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>out.println(<span class="hljs-string">&quot;Date: &quot;</span> + response.header(<span class="hljs-string">&quot;Date&quot;</span>));<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>out.println(<span class="hljs-string">&quot;Vary: &quot;</span> + response.headers(<span class="hljs-string">&quot;Vary&quot;</span>));<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="post提交string"><a href="#post提交string" class="headerlink" title="post提交string"></a>post提交string</h3><p>使用HTTP POST提交请求到服务。这个例子提交了一个markdown文档到web服务，以HTML方式渲染markdown。因为整个请求体都在内存中，因此避免使用此api提交大文档（大于1MB）</p>
<figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs vbscript"><span class="hljs-keyword">private</span> void post<span class="hljs-built_in">String</span>() throws IOException &#123;<br><br><br>    OkHttpClient client = <span class="hljs-keyword">new</span> OkHttpClient();<br><br><br>    String postBody = <span class="hljs-string">&quot;&quot;</span><br>            + <span class="hljs-string">&quot;Releases\n&quot;</span><br>            + <span class="hljs-string">&quot;--------\n&quot;</span><br>            + <span class="hljs-string">&quot;\n&quot;</span><br>            + <span class="hljs-string">&quot; * zhangfei\n&quot;</span><br>            + <span class="hljs-string">&quot; * guanyu\n&quot;</span><br>            + <span class="hljs-string">&quot; * liubei\n&quot;</span>;<br><br>    <span class="hljs-built_in">Request</span> <span class="hljs-built_in">request</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Request</span>.Builder()<br>            .url(<span class="hljs-string">&quot;https://api.github.com/markdown/raw&quot;</span>)<br>            .post(RequestBody.create(MEDIA_TYPE_MARKDOWN, postBody))<br>            .build();<br><br>    <span class="hljs-keyword">Call</span> <span class="hljs-keyword">call</span> = client.newCall(<span class="hljs-built_in">request</span>);<br>    <span class="hljs-keyword">call</span>.enqueue(<span class="hljs-keyword">new</span> Callback() &#123;<br>        @Override<br>        <span class="hljs-keyword">public</span> void onFailure(<span class="hljs-keyword">Call</span> <span class="hljs-keyword">call</span>, IOException e) &#123;<br><br>        &#125;<br>        @Override<br>        <span class="hljs-keyword">public</span> void onResponse(<span class="hljs-keyword">Call</span> <span class="hljs-keyword">call</span>, <span class="hljs-built_in">Response</span> <span class="hljs-built_in">response</span>) throws IOException &#123;<br>            System.out.println(<span class="hljs-built_in">response</span>.body().<span class="hljs-built_in">string</span>());<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="post提交流"><a href="#post提交流" class="headerlink" title="post提交流"></a>post提交流</h3><p>以流的方式POST提交请求体。请求体的内容由流写入产生。这个例子是流直接写入Okio的BufferedSink。你的程序可能会使用OutputStream，你可以使用BufferedSink.outputStream()来获取</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">MediaType</span> <span class="hljs-variable">MEDIA_TYPE_MARKDOWN</span><br>        <span class="hljs-operator">=</span> MediaType.parse(<span class="hljs-string">&quot;text/x-markdown; charset=utf-8&quot;</span>);<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postStream</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-type">RequestBody</span> <span class="hljs-variable">requestBody</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestBody</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> MediaType <span class="hljs-title function_">contentType</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> MEDIA_TYPE_MARKDOWN;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeTo</span><span class="hljs-params">(BufferedSink sink)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>            sink.writeUtf8(<span class="hljs-string">&quot;Numbers\n&quot;</span>);<br>            sink.writeUtf8(<span class="hljs-string">&quot;-------\n&quot;</span>);<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>; i &lt;= <span class="hljs-number">997</span>; i++) &#123;<br>                sink.writeUtf8(String.format(<span class="hljs-string">&quot; * %s = %s\n&quot;</span>, i, factor(i)));<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">private</span> String <span class="hljs-title function_">factor</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>; i &lt; n; i++) &#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> n / i;<br>                <span class="hljs-keyword">if</span> (x * i == n) <span class="hljs-keyword">return</span> factor(x) + <span class="hljs-string">&quot; × &quot;</span> + i;<br>            &#125;<br>            <span class="hljs-keyword">return</span> Integer.toString(n);<br>        &#125;<br>    &#125;;<br><br>    <span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>.Builder()<br>            .url(<span class="hljs-string">&quot;https://api.github.com/markdown/raw&quot;</span>)<br>            .post(requestBody)<br>            .build();<br><br>    <span class="hljs-type">Call</span> <span class="hljs-variable">call</span> <span class="hljs-operator">=</span> client.newCall(request);<br>    call.enqueue(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Callback</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFailure</span><span class="hljs-params">(Call call, IOException e)</span> &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResponse</span><span class="hljs-params">(Call call, Response response)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>            System.out.println(response.body().string());<br><br>        &#125;<br><br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="post提交表单"><a href="#post提交表单" class="headerlink" title="post提交表单"></a>post提交表单</h3><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs vbscript"><span class="hljs-keyword">private</span> void postForm() &#123;<br>    OkHttpClient client = <span class="hljs-keyword">new</span> OkHttpClient();<br><br>    RequestBody formBody = <span class="hljs-keyword">new</span> FormBody.Builder()<br>            .add(<span class="hljs-string">&quot;search&quot;</span>, <span class="hljs-string">&quot;Jurassic Park&quot;</span>)<br>            .build();<br><br>    <span class="hljs-built_in">Request</span> <span class="hljs-built_in">request</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Request</span>.Builder()<br>            .url(<span class="hljs-string">&quot;https://en.wikipedia.org/w/index.php&quot;</span>)<br>            .post(formBody)<br>            .build();<br><br>    <span class="hljs-keyword">Call</span> <span class="hljs-keyword">call</span> = client.newCall(<span class="hljs-built_in">request</span>);<br>    <span class="hljs-keyword">call</span>.enqueue(<span class="hljs-keyword">new</span> Callback() &#123;<br>        @Override<br>        <span class="hljs-keyword">public</span> void onFailure(<span class="hljs-keyword">Call</span> <span class="hljs-keyword">call</span>, IOException e) &#123;<br><br>        &#125;<br><br>        @Override<br>        <span class="hljs-keyword">public</span> void onResponse(<span class="hljs-keyword">Call</span> <span class="hljs-keyword">call</span>, <span class="hljs-built_in">Response</span> <span class="hljs-built_in">response</span>) throws IOException &#123;<br>            System.out.println(<span class="hljs-built_in">response</span>.body().<span class="hljs-built_in">string</span>());<br><br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="post请求提交分块请求"><a href="#post请求提交分块请求" class="headerlink" title="post请求提交分块请求"></a>post请求提交分块请求</h3><p>MultipartBody 可以构建复杂的请求体，与HTML文件上传形式兼容。多块请求体中每块请求都是一个请求体，可以定义自己的请求头。这些请求头可以用来描述这块请求，例如他的Content-Disposition。如果Content-Length和Content-Type可用的话，他们会被自动添加到请求头中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">IMGUR_CLIENT_ID</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;...&quot;</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">MediaType</span> <span class="hljs-variable">MEDIA_TYPE_PNG</span> <span class="hljs-operator">=</span> MediaType.parse(<span class="hljs-string">&quot;image/png&quot;</span>);<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postMultipartBody</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">OkHttpClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OkHttpClient</span>();<br><br><br>    <span class="hljs-comment">// Use the imgur image upload API as documented at https://api.imgur.com/endpoints/image</span><br>    <span class="hljs-type">MultipartBody</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MultipartBody</span>.Builder(<span class="hljs-string">&quot;AaB03x&quot;</span>)<br>            .setType(MultipartBody.FORM)<br>            .addPart(<br>                    Headers.of(<span class="hljs-string">&quot;Content-Disposition&quot;</span>, <span class="hljs-string">&quot;form-data; name=\&quot;title\&quot;&quot;</span>),<br>                    RequestBody.create(<span class="hljs-literal">null</span>, <span class="hljs-string">&quot;Square Logo&quot;</span>))<br>            .addPart(<br>                    Headers.of(<span class="hljs-string">&quot;Content-Disposition&quot;</span>, <span class="hljs-string">&quot;form-data; name=\&quot;image\&quot;&quot;</span>),<br>                    RequestBody.create(MEDIA_TYPE_PNG, <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;website/static/logo-square.png&quot;</span>)))<br>            .build();<br><br>    <span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>.Builder()<br>            .header(<span class="hljs-string">&quot;Authorization&quot;</span>, <span class="hljs-string">&quot;Client-ID &quot;</span> + IMGUR_CLIENT_ID)<br>            .url(<span class="hljs-string">&quot;https://api.imgur.com/3/image&quot;</span>)<br>            .post(body)<br>            .build();<br><br>    <span class="hljs-type">Call</span> <span class="hljs-variable">call</span> <span class="hljs-operator">=</span> client.newCall(request);<br>    call.enqueue(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Callback</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFailure</span><span class="hljs-params">(Call call, IOException e)</span> &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResponse</span><span class="hljs-params">(Call call, Response response)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>            System.out.println(response.body().string());<br><br>        &#125;<br><br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="相应缓存"><a href="#相应缓存" class="headerlink" title="相应缓存"></a>相应缓存</h3><p>为了缓存响应，你需要一个你可以读写的缓存目录，和缓存大小的限制。这个缓存目录应该是私有的，不信任的程序应不能读取缓存内容。<br>一个缓存目录同时拥有多个缓存访问是错误的。大多数程序只需要调用一次new OkHttpClient()，在第一次调用时配置好缓存，然后其他地方只需要调用这个实例就可以了。否则两个缓存示例互相干扰，破坏响应缓存，而且有可能会导致程序崩溃。<br>响应缓存使用HTTP头作为配置。你可以在请求头中添加Cache-Control: max-stale&#x3D;3600 ,OkHttp缓存会支持。你的服务通过响应头确定响应缓存多长时间，例如使用Cache-Control: max-age&#x3D;9600</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-built_in">int</span> cacheSize = <span class="hljs-number">10</span><span class="hljs-operator"> * </span><span class="hljs-number">1024</span><span class="hljs-operator"> * </span><span class="hljs-number">1024</span>; <span class="hljs-comment">// 10 MiB</span><br>Cache cache = <span class="hljs-keyword">new</span> <span class="hljs-constructor">Cache(<span class="hljs-params">cacheDirectory</span>, <span class="hljs-params">cacheSize</span>)</span>;<br><br>OkHttpClient.Builder builder = <span class="hljs-keyword">new</span> OkHttpClient.<span class="hljs-constructor">Builder()</span>;<br>builder.cache(cache);<br>OkHttpClient client = builder.build<span class="hljs-literal">()</span>;<br><br>Request request = <span class="hljs-keyword">new</span> Request.<span class="hljs-constructor">Builder()</span><br>    .url(<span class="hljs-string">&quot;http://publicobject.com/helloworld.txt&quot;</span>)<br>    .build<span class="hljs-literal">()</span>;<br><br>Call call = client.<span class="hljs-keyword">new</span><span class="hljs-constructor">Call(<span class="hljs-params">request</span>)</span>;<br>call.enqueue(<span class="hljs-keyword">new</span> <span class="hljs-constructor">Callback()</span> &#123;<br>    @Override<br>    public void on<span class="hljs-constructor">Failure(Call <span class="hljs-params">call</span>, IOException <span class="hljs-params">e</span>)</span> &#123;<br><br>    &#125;<br><br>    @Override<br>    public void on<span class="hljs-constructor">Response(Call <span class="hljs-params">call</span>, Response <span class="hljs-params">response</span>)</span> throws IOException &#123;<br>        String response1Body = response.body<span class="hljs-literal">()</span>.<span class="hljs-built_in">string</span><span class="hljs-literal">()</span>;<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>out.println(<span class="hljs-string">&quot;Response 1 response:          &quot;</span> + response);<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>out.println(<span class="hljs-string">&quot;Response 1 cache response:    &quot;</span> + response.cache<span class="hljs-constructor">Response()</span>  );<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>out.println(<span class="hljs-string">&quot;Response 1 network response:  &quot;</span> + response.networkResponse  <span class="hljs-literal">()</span>);<br>    &#125;<br><br>&#125;);<br></code></pre></td></tr></table></figure>
<h3 id="超时"><a href="#超时" class="headerlink" title="超时"></a>超时</h3><p>没有响应时使用超时结束call。没有响应的原因可能是客户点链接问题、服务器可用性问题或者这之间的其他东西。OkHttp支持连接，读取和写入超时</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">private</span> void <span class="hljs-constructor">ConfigureTimeouts()</span> &#123;<br><br>    OkHttpClient.Builder builder = <span class="hljs-keyword">new</span> OkHttpClient.<span class="hljs-constructor">Builder()</span>;<br>    OkHttpClient client = builder.build<span class="hljs-literal">()</span>;<br><br>    client.<span class="hljs-keyword">new</span><span class="hljs-constructor">Builder()</span>.connect<span class="hljs-constructor">Timeout(10, TimeUnit.SECONDS)</span>;<br>    client.<span class="hljs-keyword">new</span><span class="hljs-constructor">Builder()</span>.read<span class="hljs-constructor">Timeout(10,TimeUnit.SECONDS)</span>;<br>    client.<span class="hljs-keyword">new</span><span class="hljs-constructor">Builder()</span>.write<span class="hljs-constructor">Timeout(10,TimeUnit.SECONDS)</span>;<br><br>    Request request = <span class="hljs-keyword">new</span> Request.<span class="hljs-constructor">Builder()</span><br>            .url(<span class="hljs-string">&quot;http://httpbin.org/delay/2&quot;</span>) <span class="hljs-comment">// This URL is served with a 2 second delay.</span><br>            .build<span class="hljs-literal">()</span>;<br><br>    Call call = client.<span class="hljs-keyword">new</span><span class="hljs-constructor">Call(<span class="hljs-params">request</span>)</span>;<br>    call.enqueue(<span class="hljs-keyword">new</span> <span class="hljs-constructor">Callback()</span> &#123;<br>        @Override<br>        public void on<span class="hljs-constructor">Failure(Call <span class="hljs-params">call</span>, IOException <span class="hljs-params">e</span>)</span> &#123;<br><br>        &#125;<br><br>        @Override<br>        public void on<span class="hljs-constructor">Response(Call <span class="hljs-params">call</span>, Response <span class="hljs-params">response</span>)</span> throws IOException &#123;<br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>out.println(<span class="hljs-string">&quot;Response completed: &quot;</span> + response);<br>        &#125;<br><br>    &#125;);<br><br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="OkHttp的封装"><a href="#OkHttp的封装" class="headerlink" title="OkHttp的封装"></a>OkHttp的封装</h2><p>新建一个工具类HttpUtils </p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs axapta"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> OkHttpClient <span class="hljs-keyword">client</span> = <span class="hljs-literal">null</span>;<br><br><span class="hljs-keyword">private</span> HttpUtils() &#123;&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> OkHttpClient getInstance() &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">client</span> == <span class="hljs-literal">null</span>) &#123;<br>        synchronized (HttpUtils.<span class="hljs-keyword">class</span>) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">client</span> == <span class="hljs-literal">null</span>)<br>                <span class="hljs-keyword">client</span> = <span class="hljs-keyword">new</span> OkHttpClient();<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">client</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>get异步请求</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">    <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * Get请求</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * @param url</span><br><span class="hljs-comment">    * @param callback</span><br><span class="hljs-comment">    */</span><br>public static void <span class="hljs-keyword">do</span><span class="hljs-constructor">Get(String <span class="hljs-params">url</span>, Callback <span class="hljs-params">callback</span>)</span> &#123;<br>    Request request = <span class="hljs-keyword">new</span> Request.<span class="hljs-constructor">Builder()</span><br>            .url(url)<br>            .build<span class="hljs-literal">()</span>;<br>    Call call = get<span class="hljs-constructor">Instance()</span>.<span class="hljs-keyword">new</span><span class="hljs-constructor">Call(<span class="hljs-params">request</span>)</span>;<br>    call.enqueue(callback);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>post请求发送键值对</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">    <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * Post请求发送键值对数据</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * @param url</span><br><span class="hljs-comment">    * @param mapParams</span><br><span class="hljs-comment">    * @param callback</span><br><span class="hljs-comment">    */</span><br>public static void <span class="hljs-keyword">do</span><span class="hljs-constructor">Post(String <span class="hljs-params">url</span>, Map&lt;String, String&gt; <span class="hljs-params">mapParams</span>, Callback <span class="hljs-params">callback</span>)</span> &#123;<br>    FormBody.Builder builder = <span class="hljs-keyword">new</span> FormBody.<span class="hljs-constructor">Builder()</span>;<br>    <span class="hljs-keyword">for</span> (String key : mapParams.key<span class="hljs-constructor">Set()</span>) &#123;<br>        builder.add(key, mapParams.get(key));<br>    &#125;<br>    Request request = <span class="hljs-keyword">new</span> Request.<span class="hljs-constructor">Builder()</span><br>            .url(url)<br>            .post(builder.build<span class="hljs-literal">()</span>)<br>            .build<span class="hljs-literal">()</span>;<br>    Call call = get<span class="hljs-constructor">Instance()</span>.<span class="hljs-keyword">new</span><span class="hljs-constructor">Call(<span class="hljs-params">request</span>)</span>;<br>    call.enqueue(callback);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>post请求发送json数据</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">    <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * Post请求发送JSON数据</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * @param url</span><br><span class="hljs-comment">    * @param jsonParams</span><br><span class="hljs-comment">    * @param callback</span><br><span class="hljs-comment">    */</span><br>public static void <span class="hljs-keyword">do</span><span class="hljs-constructor">Post(String <span class="hljs-params">url</span>, String <span class="hljs-params">jsonParams</span>, Callback <span class="hljs-params">callback</span>)</span> &#123;<br>    RequestBody body = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">RequestBody</span>.</span></span>create(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">MediaType</span>.</span></span>parse(<span class="hljs-string">&quot;application/json; charset=utf-8&quot;</span>)<br>            , jsonParams);<br>    Request request = <span class="hljs-keyword">new</span> Request.<span class="hljs-constructor">Builder()</span><br>            .url(url)<br>            .post(body)<br>            .build<span class="hljs-literal">()</span>;<br>    Call call = get<span class="hljs-constructor">Instance()</span>.<span class="hljs-keyword">new</span><span class="hljs-constructor">Call(<span class="hljs-params">request</span>)</span>;<br>    call.enqueue(callback);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>文件上传</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">    <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 上传文件</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * @param url</span><br><span class="hljs-comment">    * @param pathName</span><br><span class="hljs-comment">    * @param fileName</span><br><span class="hljs-comment">    * @param callback</span><br><span class="hljs-comment">    */</span><br>public static void <span class="hljs-keyword">do</span><span class="hljs-constructor">File(String <span class="hljs-params">url</span>, String <span class="hljs-params">pathName</span>, String <span class="hljs-params">fileName</span>, Callback <span class="hljs-params">callback</span>)</span> &#123;<br>    <span class="hljs-comment">//判断文件类型</span><br>    MediaType MEDIA_TYPE = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">MediaType</span>.</span></span>parse(judge<span class="hljs-constructor">Type(<span class="hljs-params">pathName</span>)</span>);<br>    <span class="hljs-comment">//创建文件参数</span><br>    MultipartBody.Builder builder = <span class="hljs-keyword">new</span> MultipartBody.<span class="hljs-constructor">Builder()</span><br>            .set<span class="hljs-constructor">Type(MultipartBody.FORM)</span><br>            .add<span class="hljs-constructor">FormDataPart(MEDIA_TYPE.<span class="hljs-params">type</span>()</span>, fileName,<br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">RequestBody</span>.</span></span>create(MEDIA_TYPE, <span class="hljs-keyword">new</span> <span class="hljs-constructor">File(<span class="hljs-params">pathName</span>)</span>));<br>    <span class="hljs-comment">//发出请求参数</span><br>    Request request = <span class="hljs-keyword">new</span> Request.<span class="hljs-constructor">Builder()</span><br>            .header(<span class="hljs-string">&quot;Authorization&quot;</span>, <span class="hljs-string">&quot;Client-ID &quot;</span> + <span class="hljs-string">&quot;9199fdef135c122&quot;</span>)<br>            .url(url)<br>            .post(builder.build<span class="hljs-literal">()</span>)<br>            .build<span class="hljs-literal">()</span>;<br>    Call call = get<span class="hljs-constructor">Instance()</span>.<span class="hljs-keyword">new</span><span class="hljs-constructor">Call(<span class="hljs-params">request</span>)</span>;<br>    call.enqueue(callback);<br>&#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 根据文件路径判断MediaType</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * @param path</span><br><span class="hljs-comment">    * @return</span><br><span class="hljs-comment">    */</span><br><span class="hljs-keyword">private</span> static String judge<span class="hljs-constructor">Type(String <span class="hljs-params">path</span>)</span> &#123;<br>    FileNameMap fileNameMap = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">URLConnection</span>.</span></span>get<span class="hljs-constructor">FileNameMap()</span>;<br>    String contentTypeFor = fileNameMap.get<span class="hljs-constructor">ContentTypeFor(<span class="hljs-params">path</span>)</span>;<br>    <span class="hljs-keyword">if</span> (contentTypeFor<span class="hljs-operator"> == </span>null) &#123;<br>        contentTypeFor = <span class="hljs-string">&quot;application/octet-stream&quot;</span>;<br>    &#125;<br>    return contentTypeFor;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>下载文件</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs gradle">    <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 下载文件</span><br><span class="hljs-comment">    * @param url</span><br><span class="hljs-comment">    * @param fileDir</span><br><span class="hljs-comment">    * @param fileName</span><br><span class="hljs-comment">    */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> downFile(String url, <span class="hljs-keyword">final</span> String fileDir, <span class="hljs-keyword">final</span> String fileName) &#123;<br>    Request request = <span class="hljs-keyword">new</span> Request.Builder()<br>            .url(url)<br>            .build();<br>    <span class="hljs-keyword">Call</span> <span class="hljs-keyword">call</span> = getInstance().newCall(request);<br>    <span class="hljs-keyword">call</span>.enqueue(<span class="hljs-keyword">new</span> Callback() &#123;<br>        @Override<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> onFailure(<span class="hljs-keyword">Call</span> <span class="hljs-keyword">call</span>, IOException e) &#123;<br><br>        &#125;<br><br>        @Override<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> onResponse(<span class="hljs-keyword">Call</span> <span class="hljs-keyword">call</span>, Response response) <span class="hljs-keyword">throws</span> IOException &#123;<br>            InputStream is = <span class="hljs-keyword">null</span>;<br>            <span class="hljs-keyword">byte</span>[] buf = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">2048</span>];<br>            <span class="hljs-keyword">int</span> len = <span class="hljs-number">0</span>;<br>            FileOutputStream fos = <span class="hljs-keyword">null</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>                is = response.body().byteStream();<br>                <span class="hljs-keyword">File</span> <span class="hljs-keyword">file</span> = <span class="hljs-keyword">new</span> <span class="hljs-keyword">File</span>(fileDir, fileName);<br>                fos = <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-keyword">file</span>);<br>                <span class="hljs-keyword">while</span> ((len = is.<span class="hljs-keyword">read</span>(buf)) != -<span class="hljs-number">1</span>) &#123;<br>                    fos.<span class="hljs-keyword">write</span>(buf, <span class="hljs-number">0</span>, len);<br>                &#125;<br>                fos.flush();<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-keyword">if</span> (is != <span class="hljs-keyword">null</span>) is.close();<br>                <span class="hljs-keyword">if</span> (fos != <span class="hljs-keyword">null</span>) fos.close();<br>            &#125;<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>如果在下载的过程中需要获取进度，可以通过onResponse回调的内容</p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs axapta">@Override<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> onResponse(Call call, Response response) throws IOException &#123;<br>    InputStream <span class="hljs-keyword">is</span> = <span class="hljs-literal">null</span>;<br>    <span class="hljs-built_in">byte</span>[] buf = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">2048</span>];<br>    <span class="hljs-built_in">int</span> len = <span class="hljs-number">0</span>;<br>    FileOutputStream fos = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">is</span> = response.body().byteStream();<br>        File file = <span class="hljs-keyword">new</span> File(fileDir, fileName);<br>        fos = <span class="hljs-keyword">new</span> FileOutputStream(file);<br>        <span class="hljs-comment">//---增加的代码---</span><br>        <span class="hljs-comment">//计算进度</span><br>        <span class="hljs-built_in">long</span> totalSize = response.body().contentLength();<br>        <span class="hljs-built_in">long</span> <span class="hljs-keyword">sum</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span> ((len = <span class="hljs-keyword">is</span>.read(buf)) != <span class="hljs-number">-1</span>) &#123;<br>            <span class="hljs-keyword">sum</span> += len;<br>            <span class="hljs-comment">//progress就是进度值</span><br>            <span class="hljs-built_in">int</span> progress = (<span class="hljs-built_in">int</span>) (<span class="hljs-keyword">sum</span> * <span class="hljs-number">1.0</span>f/totalSize * <span class="hljs-number">100</span>);<br>            <span class="hljs-comment">//---增加的代码---</span><br>            fos.write(buf, <span class="hljs-number">0</span>, len);<br>        &#125;<br>        fos.<span class="hljs-keyword">flush</span>();<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        e.printStackTrace();<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">is</span> != <span class="hljs-literal">null</span>) <span class="hljs-keyword">is</span>.close();<br>        <span class="hljs-keyword">if</span> (fos != <span class="hljs-literal">null</span>) fos.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>上面的举例比较简单，因为现在又出了一个新的内容也就是retrofit2，而且他的使用方便度不亚于OkHttp，目前使用的较多，所以我们把重心放在这里</p>
</blockquote>
<h1 id="Retrofit2"><a href="#Retrofit2" class="headerlink" title="Retrofit2"></a>Retrofit2</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Retrofit是一个RESTful的网络请求框架，基于OkHttp<br>特点：</p>
<ol>
<li>通过注解的方式配置网络参数</li>
<li>支持同步，异步网络请求</li>
<li>支持多种数据解析和数据序列化</li>
<li>提供对Rxjava的支持</li>
</ol>
<blockquote>
<p>注意：其实网络请求的本质工作是有OkHttp完成的，Retrofit只是完成了对数据的封装<br>     APP通过Retrofit进行网络请求，其实只是使用了Retrofit接口封装请求参数，Header，URL等信息</p>
</blockquote>
<h2 id="使用介绍"><a href="#使用介绍" class="headerlink" title="使用介绍"></a>使用介绍</h2><p>使用Retrofit的步骤共有7步</p>
<ol>
<li>添加Retrofit库依赖</li>
<li>创建接受服务器数据返回的类</li>
<li>创建用于描述网络请求接口的类</li>
<li>创建Retrofit实例</li>
<li>创建网络请求接口实例并配置网络请求参数</li>
<li>发送网络请求</li>
<li>处理服务器返回数据</li>
</ol>
<p>下面对以上的7个步骤，依次分析</p>
<h3 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h3><p>不仅需要Retrofit，而且需要OkHttp</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">dependencies</span> &#123;<br>    <span class="hljs-keyword">compile</span> <span class="hljs-string">&#x27;com.squareup.retrofit2:retrofit:2.0.2&#x27;</span><br>    <span class="hljs-comment">// Retrofit库</span><br>    <span class="hljs-keyword">compile</span> <span class="hljs-string">&#x27;com.squareup.okhttp3:okhttp:3.1.2&#x27;</span><br>    <span class="hljs-comment">// Okhttp库</span><br>  &#125;<br></code></pre></td></tr></table></figure>
<p>网络请求权限</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">&lt;uses-permission android:<span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;android.permission.INTERNET&quot;</span>/&gt;<br></code></pre></td></tr></table></figure>
<h3 id="创建接受服务器数据返回的类-Reception"><a href="#创建接受服务器数据返回的类-Reception" class="headerlink" title="创建接受服务器数据返回的类  Reception"></a>创建接受服务器数据返回的类  Reception</h3><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-symbol">Reception</span> &#123;<br>    ...<br>    <span class="hljs-comment">// 根据返回数据的格式和数据解析方式（Json、XML等）定义</span><br>    <span class="hljs-comment">// 下面会在实例进行说明</span><br>        &#125;<br><br></code></pre></td></tr></table></figure>
<h3 id="创建用于描述网络请求接口的类"><a href="#创建用于描述网络请求接口的类" class="headerlink" title="创建用于描述网络请求接口的类"></a>创建用于描述网络请求接口的类</h3><p>Retrofit将Http请求抽象为Java接口：采用注解的方式描述网络请求参数和配置网络请求信息</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-symbol">Reception</span> &#123;<br>    ...<br>    <span class="hljs-comment">// 根据返回数据的格式和数据解析方式（Json、XML等）定义</span><br>    <span class="hljs-comment">// 下面会在实例进行说明</span><br>        &#125;<br></code></pre></td></tr></table></figure>
<h3 id="注解类型"><a href="#注解类型" class="headerlink" title="注解类型"></a>注解类型</h3><p><a href="/assets/android/android-network-note.png"></a></p>
<h4 id="网络请求方法"><a href="#网络请求方法" class="headerlink" title="网络请求方法"></a>网络请求方法</h4><p><a href="/assets/android/network-way.png"></a><br>说明：</p>
<ol>
<li>@GET、@POST、@PUT、@DELETE、@HEAD<br>以上方法分别对应 HTTP中的网络请求方式<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">public interface GetRequest_Interface &#123;<br><br>    @GET<span class="hljs-params">(&quot;openapi.do?<span class="hljs-attr">keyfrom</span>=Yanzhikai&amp;<span class="hljs-attr">key</span>=2032414398&amp;<span class="hljs-attr">type</span>=data&amp;<span class="hljs-attr">doctype</span>=json&amp;<span class="hljs-attr">version</span>=1.1&amp;<span class="hljs-attr">q</span>=car&quot;)</span><br>    Call&lt;Translation&gt;  getCall<span class="hljs-params">()</span>;<br>    <span class="hljs-string">//</span> @GET注解的作用:采用Get方法发送网络请求<br>    <span class="hljs-string">//</span> getCall<span class="hljs-params">()</span> = 接收网络请求数据的方法<br>    <span class="hljs-string">//</span> 其中返回类型为Call&lt;*&gt;，*是接收数据的类（即上面定义的Translation类）<br>&#125;<br></code></pre></td></tr></table></figure>
此处特意说明URL的组成：Retrofit把 网络请求的URL 分成了两部分设置<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-string">//</span> 第1部分：在网络请求接口的注解设置<br> @GET<span class="hljs-params">(&quot;openapi.do?<span class="hljs-attr">keyfrom</span>=Yanzhikai&amp;<span class="hljs-attr">key</span>=2032414398&amp;<span class="hljs-attr">type</span>=data&amp;<span class="hljs-attr">doctype</span>=json&amp;<span class="hljs-attr">version</span>=1.1&amp;<span class="hljs-attr">q</span>=car&quot;)</span><br>Call&lt;Translation&gt;  getCall<span class="hljs-params">()</span>;<br><br><span class="hljs-string">//</span> 第2部分：在创建Retrofit实例时通过<span class="hljs-string">.baseUrl</span><span class="hljs-params">()</span>设置<br>Retrofit retrofit = new Retrofit.Builder<span class="hljs-params">()</span><br>                <span class="hljs-string">.baseUrl</span><span class="hljs-params">(&quot;http://fanyi.youdao.com/&quot;)</span> <span class="hljs-string">//</span>设置网络请求的Url地址<br>                <span class="hljs-string">.addConverterFactory</span><span class="hljs-params">(GsonConverterFactory.create()</span>) <span class="hljs-string">//</span>设置数据解析器<br>                <span class="hljs-string">.build</span><span class="hljs-params">()</span>;<br><br><span class="hljs-string">//</span> 从上面看出：一个请求的URL可以通过 替换块 和 请求方法的参数 来进行动态的URL更新。<br><span class="hljs-string">//</span> 替换块是由 被&#123;&#125;包裹起来的字符串构成<br><span class="hljs-string">//</span> 即：Retrofit支持动态改变网络请求根目录<br></code></pre></td></tr></table></figure>
<blockquote>
<p>网络请求的完整 Url &#x3D;在创建Retrofit实例时通过.baseUrl()设置 +网络请求接口的注解设置（下面称 “path“ ）</p>
</blockquote>
</li>
<li>@HTTP<br>作用：替换@GET、@POST、@PUT、@DELETE、@HEAD注解的作用 及 更多功能拓展<br>具体使用：通过属性method、path、hasBody进行设置<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">interface</span> <span class="hljs-selector-tag">GetRequest_Interface</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * method：网络请求的方法（区分大小写）</span><br><span class="hljs-comment">     * path：网络请求地址路径</span><br><span class="hljs-comment">     * hasBody：是否有请求体</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-variable">@HTTP</span>(method = <span class="hljs-string">&quot;GET&quot;</span>, path = <span class="hljs-string">&quot;blog/&#123;id&#125;&quot;</span>, hasBody = false)<br>    Call&lt;ResponseBody&gt; <span class="hljs-built_in">getCall</span>(<span class="hljs-variable">@Path</span>(<span class="hljs-string">&quot;id&quot;</span>) int id);<br>    <span class="hljs-comment">// &#123;id&#125; 表示是一个变量</span><br>    <span class="hljs-comment">// method 的值 retrofit 不会做处理，所以要自行保证准确</span><br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<h4 id="标记"><a href="#标记" class="headerlink" title="标记"></a>标记</h4><ol>
<li><p>@FormUrlEncoded<br>作用：表示发送form-encoded的数据</p>
<blockquote>
<p>每个键值对需要用@Filed来注解键名，随后的对象需要提供值。</p>
</blockquote>
</li>
<li><p>@Multipart<br>作用：表示发送form-encoded的数据（适用于 有文件 上传的场景） </p>
<blockquote>
<p>每个键值对需要用@Part来注解键名，随后的对象需要提供值。<br>具体使用如下：<br>GetRequest_Interface</p>
</blockquote>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">GetRequest_Interface</span> &#123;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         *表明是一个表单格式的请求（Content-Type:application/x-www-form-urlencoded）</span><br><span class="hljs-comment">         * Field(&quot;username&quot;) 表示将后面的 String name中name的取值作为 username 的值</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-meta">@POST(<span class="hljs-string">&quot;/form&quot;</span>)</span><br>        <span class="hljs-meta">@FormUrlEncoded</span><br>        Call&lt;ResponseBody&gt; testFormUrlEncoded1(<span class="hljs-meta">@Field(<span class="hljs-string">&quot;username&quot;</span>)</span> String name, <span class="hljs-meta">@Field(<span class="hljs-string">&quot;age&quot;</span>)</span> int age);<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * &#123;<span class="hljs-doctag">@link</span> Part&#125; 后面支持三种类型，&#123;<span class="hljs-doctag">@link</span> RequestBody&#125;、&#123;<span class="hljs-doctag">@link</span> okhttp3.MultipartBody.Part&#125; 、任意类型</span><br><span class="hljs-comment">         * 除 &#123;<span class="hljs-doctag">@link</span> okhttp3.MultipartBody.Part&#125; 以外，其它类型都必须带上表单字段(&#123;<span class="hljs-doctag">@link</span> okhttp3.MultipartBody.Part&#125; 中已经包含了表单字段的信息)，</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-meta">@POST(<span class="hljs-string">&quot;/form&quot;</span>)</span><br>        <span class="hljs-meta">@Multipart</span><br>        Call&lt;ResponseBody&gt; testFileUpload1(<span class="hljs-meta">@Part(<span class="hljs-string">&quot;name&quot;</span>)</span> RequestBody name, <span class="hljs-meta">@Part(<span class="hljs-string">&quot;age&quot;</span>)</span> RequestBody age, <span class="hljs-meta">@Part</span> MultipartBody.Part file);<br><br>&#125;<br><br><span class="hljs-comment">// 具体使用</span><br>       GetRequest_Interface service = retrofit.create(GetRequest_Interface.<span class="hljs-keyword">class</span>);<br>        <span class="hljs-comment">// @FormUrlEncoded </span><br>        Call&lt;ResponseBody&gt; call1 = service.testFormUrlEncoded1(<span class="hljs-string">&quot;Carson&quot;</span>, <span class="hljs-number">24</span>);<br><br>        <span class="hljs-comment">//  @Multipart</span><br>        RequestBody name = RequestBody.create(textType, <span class="hljs-string">&quot;Carson&quot;</span>);<br>        RequestBody age = RequestBody.create(textType, <span class="hljs-string">&quot;24&quot;</span>);<br><br>        MultipartBody.Part filePart = MultipartBody.Part.createFormData(<span class="hljs-string">&quot;file&quot;</span>, <span class="hljs-string">&quot;test.txt&quot;</span>, file);<br>        Call&lt;ResponseBody&gt; call3 = service.testFileUpload1(name, age, filePart);<br></code></pre></td></tr></table></figure></li>
</ol>
<h4 id="网络请求参数"><a href="#网络请求参数" class="headerlink" title="网络请求参数"></a>网络请求参数</h4><p><a href="/assets/android/network-params.png"></a></p>
<ol>
<li>@Header &amp; @Headers<br>作用：添加请求头 &amp;添加不固定的请求头<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-comment">// @Header</span><br><span class="hljs-variable">@GET</span>(<span class="hljs-string">&quot;user&quot;</span>)<br>Call&lt;User&gt; <span class="hljs-built_in">getUser</span>(<span class="hljs-variable">@Header</span>(<span class="hljs-string">&quot;Authorization&quot;</span>) String authorization)<br><br><span class="hljs-comment">// @Headers</span><br><span class="hljs-variable">@Headers</span>(<span class="hljs-string">&quot;Authorization: authorization&quot;</span>)<br><span class="hljs-variable">@GET</span>(<span class="hljs-string">&quot;user&quot;</span>)<br>Call&lt;User&gt; <span class="hljs-built_in">getUser</span>()<br><br><span class="hljs-comment">// 以上的效果是一致的。</span><br><span class="hljs-comment">// 区别在于使用场景和使用方式</span><br><span class="hljs-comment">// 1. 使用场景：@Header用于添加不固定的请求头，@Headers用于添加固定的请求头</span><br><span class="hljs-comment">// 2. 使用方式：@Header作用于方法的参数；@Headers作用于方法</span><br></code></pre></td></tr></table></figure></li>
<li>@Body<br>作用：以 Post方式 传递 自定义数据类型 给服务器<blockquote>
<p>如果提交的是一个Map，那么作用相当于 @Field<br>不过Map要经过 FormBody.Builder 类处理成为符合 Okhttp 格式的表单</p>
</blockquote>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs csharp">FormBody.Builder builder = <span class="hljs-keyword">new</span> FormBody.Builder();<br>builder.<span class="hljs-keyword">add</span>(<span class="hljs-string">&quot;key&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>);<br></code></pre></td></tr></table></figure></li>
<li>@Field &amp; @FieldMap<br>作用：发送 Post请求 时提交请求的表单字段<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs livescript">public interface GetRequest_Interface &#123;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         *表明是一个表单格式的请求（Content-Type:application/x-www-form-urlencoded）</span><br><span class="hljs-comment">         * &lt;code&gt;Field(&quot;username&quot;)&lt;/code&gt; 表示将后面的 &lt;code&gt;String name&lt;/code&gt; 中name的取值作为 username 的值</span><br><span class="hljs-comment">         */</span><br>        @POST(<span class="hljs-string">&quot;/form&quot;</span>)<br>        @FormUrlEncoded<br>        Call&lt;ResponseBody&gt; testFormUrlEncoded1(@Field(<span class="hljs-string">&quot;username&quot;</span>) <span class="hljs-built_in">String</span> name, @Field(<span class="hljs-string">&quot;age&quot;</span>) int age);<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Map的key作为表单的键</span><br><span class="hljs-comment">         */</span><br>        @POST(<span class="hljs-string">&quot;/form&quot;</span>)<br>        @FormUrlEncoded<br>        Call&lt;ResponseBody&gt; testFormUrlEncoded2(@FieldMap <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">Object</span>&gt; <span class="hljs-keyword">map</span>);<br><br>&#125;<br><br><span class="hljs-regexp">// 具体使用</span><br><span class="hljs-regexp">         //</span> @Field<br>        Call&lt;ResponseBody&gt; call1 = service.testFormUrlEncoded1(<span class="hljs-string">&quot;Carson&quot;</span>, <span class="hljs-number">24</span>);<br><br>        <span class="hljs-regexp">// @FieldMap</span><br><span class="hljs-regexp">        //</span> 实现的效果与上面相同，但要传入<span class="hljs-built_in">Map</span><br>        <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">Object</span>&gt; <span class="hljs-keyword">map</span> = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        <span class="hljs-keyword">map</span>.put(<span class="hljs-string">&quot;username&quot;</span>, <span class="hljs-string">&quot;Carson&quot;</span>);<br>        <span class="hljs-keyword">map</span>.put(<span class="hljs-string">&quot;age&quot;</span>, <span class="hljs-number">24</span>);<br>        Call&lt;ResponseBody&gt; call2 = service.testFormUrlEncoded2(<span class="hljs-keyword">map</span>);<br></code></pre></td></tr></table></figure></li>
<li>@Part &amp; @PartMap<br>作用：发送 Post请求 时提交请求的表单字段<blockquote>
<p>与@Field的区别：功能相同，但携带的参数类型更加丰富，包括数据流，所以适用于 有文件上传 的场景</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">GetRequest_Interface</span> &#123;<br><br>          <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * &#123;<span class="hljs-doctag">@link</span> Part&#125; 后面支持三种类型，&#123;<span class="hljs-doctag">@link</span> RequestBody&#125;、&#123;<span class="hljs-doctag">@link</span> okhttp3.MultipartBody.Part&#125; 、任意类型</span><br><span class="hljs-comment">         * 除 &#123;<span class="hljs-doctag">@link</span> okhttp3.MultipartBody.Part&#125; 以外，其它类型都必须带上表单字段(&#123;<span class="hljs-doctag">@link</span> okhttp3.MultipartBody.Part&#125; 中已经包含了表单字段的信息)，</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-meta">@POST(&quot;/form&quot;)</span><br>        <span class="hljs-meta">@Multipart</span><br>        Call&lt;ResponseBody&gt; <span class="hljs-title function_">testFileUpload1</span><span class="hljs-params">(<span class="hljs-meta">@Part(&quot;name&quot;)</span> RequestBody name, <span class="hljs-meta">@Part(&quot;age&quot;)</span> RequestBody age, <span class="hljs-meta">@Part</span> MultipartBody.Part file)</span>;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * PartMap 注解支持一个Map作为参数，支持 &#123;<span class="hljs-doctag">@link</span> RequestBody &#125; 类型，</span><br><span class="hljs-comment">         * 如果有其它的类型，会被&#123;<span class="hljs-doctag">@link</span> retrofit2.Converter&#125;转换，如后面会介绍的 使用&#123;<span class="hljs-doctag">@link</span> com.google.gson.Gson&#125; 的 &#123;<span class="hljs-doctag">@link</span> retrofit2.converter.gson.GsonRequestBodyConverter&#125;</span><br><span class="hljs-comment">         * 所以&#123;<span class="hljs-doctag">@link</span> MultipartBody.Part&#125; 就不适用了,所以文件只能用&lt;b&gt; <span class="hljs-doctag">@Part</span> MultipartBody.Part &lt;/b&gt;</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-meta">@POST(&quot;/form&quot;)</span><br>        <span class="hljs-meta">@Multipart</span><br>        Call&lt;ResponseBody&gt; <span class="hljs-title function_">testFileUpload2</span><span class="hljs-params">(<span class="hljs-meta">@PartMap</span> Map&lt;String, RequestBody&gt; args, <span class="hljs-meta">@Part</span> MultipartBody.Part file)</span>;<br><br>        <span class="hljs-meta">@POST(&quot;/form&quot;)</span><br>        <span class="hljs-meta">@Multipart</span><br>        Call&lt;ResponseBody&gt; <span class="hljs-title function_">testFileUpload3</span><span class="hljs-params">(<span class="hljs-meta">@PartMap</span> Map&lt;String, RequestBody&gt; args)</span>;<br>&#125;<br><br><span class="hljs-comment">// 具体使用</span><br> <span class="hljs-type">MediaType</span> <span class="hljs-variable">textType</span> <span class="hljs-operator">=</span> MediaType.parse(<span class="hljs-string">&quot;text/plain&quot;</span>);<br>        <span class="hljs-type">RequestBody</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> RequestBody.create(textType, <span class="hljs-string">&quot;Carson&quot;</span>);<br>        <span class="hljs-type">RequestBody</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> RequestBody.create(textType, <span class="hljs-string">&quot;24&quot;</span>);<br>        <span class="hljs-type">RequestBody</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> RequestBody.create(MediaType.parse(<span class="hljs-string">&quot;application/octet-stream&quot;</span>), <span class="hljs-string">&quot;这里是模拟文件的内容&quot;</span>);<br><br>        <span class="hljs-comment">// @Part</span><br>        MultipartBody.<span class="hljs-type">Part</span> <span class="hljs-variable">filePart</span> <span class="hljs-operator">=</span> MultipartBody.Part.createFormData(<span class="hljs-string">&quot;file&quot;</span>, <span class="hljs-string">&quot;test.txt&quot;</span>, file);<br>        Call&lt;ResponseBody&gt; call3 = service.testFileUpload1(name, age, filePart);<br>        ResponseBodyPrinter.printResponseBody(call3);<br><br>        <span class="hljs-comment">// @PartMap</span><br>        <span class="hljs-comment">// 实现和上面同样的效果</span><br>        Map&lt;String, RequestBody&gt; fileUpload2Args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        fileUpload2Args.put(<span class="hljs-string">&quot;name&quot;</span>, name);<br>        fileUpload2Args.put(<span class="hljs-string">&quot;age&quot;</span>, age);<br>        <span class="hljs-comment">//这里并不会被当成文件，因为没有文件名(包含在Content-Disposition请求头中)，但上面的 filePart 有</span><br>        <span class="hljs-comment">//fileUpload2Args.put(&quot;file&quot;, file);</span><br>        Call&lt;ResponseBody&gt; call4 = service.testFileUpload2(fileUpload2Args, filePart); <span class="hljs-comment">//单独处理文件</span><br>        ResponseBodyPrinter.printResponseBody(call4);<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li>@Query和@QueryMap<br>作用：用于 @GET 方法的查询参数（Query &#x3D; Url 中 ‘?’ 后面的 key-value）<blockquote>
<p>如：url &#x3D; <a target="_blank" rel="noopener" href="http://www.println.net/?cate=android%EF%BC%8C%E5%85%B6%E4%B8%AD%EF%BC%8CQuery">http://www.println.net/?cate=android，其中，Query</a> &#x3D; cate</p>
</blockquote>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs less"> <span class="hljs-variable">@GET</span>(<span class="hljs-string">&quot;/&quot;</span>)    <br>   Call&lt;String&gt; <span class="hljs-built_in">cate</span>(<span class="hljs-variable">@Query</span>(<span class="hljs-string">&quot;cate&quot;</span>) String cate);<br>&#125;<br><br><span class="hljs-comment">// 其使用方式同 @Field与@FieldMap，这里不作过多描述</span><br></code></pre></td></tr></table></figure></li>
<li>@Path<br>作用：URL地址的缺省值<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">interface</span> <span class="hljs-selector-tag">GetRequest_Interface</span> &#123;<br><br>        <span class="hljs-variable">@GET</span>(<span class="hljs-string">&quot;users/&#123;user&#125;/repos&quot;</span>)<br>        Call&lt;ResponseBody&gt;  getBlog（<span class="hljs-variable">@Path</span>(<span class="hljs-string">&quot;user&quot;</span>) String user ）;<br>        <span class="hljs-comment">// 访问的API是：https://api.github.com/users/&#123;user&#125;/repos</span><br>        <span class="hljs-comment">// 在发起请求时， &#123;user&#125; 会被替换为方法的第一个参数 user（被@Path注解作用）</span><br>    &#125;<br></code></pre></td></tr></table></figure></li>
<li>@Url<br>作用：直接传入一个请求的 URL变量 用于URL设置<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">interface</span> <span class="hljs-selector-tag">GetRequest_Interface</span> &#123;<br><br>        <span class="hljs-variable">@GET</span><br>        Call&lt;ResponseBody&gt; <span class="hljs-built_in">testUrlAndQuery</span>(<span class="hljs-variable">@Url</span> String url, <span class="hljs-variable">@Query</span>(<span class="hljs-string">&quot;showAll&quot;</span>) boolean showAll);<br>       <span class="hljs-comment">// 当有URL注解时，@GET传入的URL就可以省略</span><br>       <span class="hljs-comment">// 当GET、POST...HTTP等方法中没有设置Url时，则必须使用 &#123;@link Url&#125;提供</span><br><br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<h3 id="创建Retrofit实例"><a href="#创建Retrofit实例" class="headerlink" title="创建Retrofit实例"></a>创建Retrofit实例</h3><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">Retrofit retrofit = <span class="hljs-keyword">new</span> Retrofit.<span class="hljs-constructor">Builder()</span><br>                .base<span class="hljs-constructor">Url(<span class="hljs-string">&quot;http://fanyi.youdao.com/&quot;</span>)</span> <span class="hljs-comment">// 设置网络请求的Url地址</span><br>                .add<span class="hljs-constructor">ConverterFactory(GsonConverterFactory.<span class="hljs-params">create</span>()</span>) <span class="hljs-comment">// 设置数据解析器</span><br>                .add<span class="hljs-constructor">CallAdapterFactory(RxJavaCallAdapterFactory.<span class="hljs-params">create</span>()</span>) <span class="hljs-comment">// 支持RxJava平台</span><br>                .build<span class="hljs-literal">()</span>;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>关于数据解析<br>Retrofit支持多种数据解析</p>
</blockquote>
<table>
<thead>
<tr>
<th>数据解析器</th>
<th align="left">Gradle依赖</th>
</tr>
</thead>
<tbody><tr>
<td>Gson</td>
<td align="left">com.squareup.retrofit2:converter-gson:2.0.2</td>
</tr>
<tr>
<td>Jackson</td>
<td align="left">com.squareup.retrofit2:converter-jackson:2.0.2</td>
</tr>
<tr>
<td>Simple XML</td>
<td align="left">com.squareup.retrofit2:converter-simplexml:2.0.2</td>
</tr>
<tr>
<td>Protobuf</td>
<td align="left">com.squareup.retrofit2:converter-protobuf:2.0.2</td>
</tr>
<tr>
<td>Moshi</td>
<td align="left">com.squareup.retrofit2:converter-moshi:2.0.2</td>
</tr>
<tr>
<td>Wire</td>
<td align="left">com.squareup.retrofit2:converter-wire:2.0.2</td>
</tr>
<tr>
<td>Scalars</td>
<td align="left">com.squareup.retrofit2:converter-scalars:2.0.2</td>
</tr>
</tbody></table>
<blockquote>
<p>关于网络适配器<br>Retrofit支持多种网络请求适配器方式：guava、Java8和rxjava<br>使用时如使用的是 Android 默认的 CallAdapter，则不需要添加网络请求适配器的依赖，否则则需要按照需求进行添加     Retrofit 提供的 CallAdapter</p>
</blockquote>
<h3 id="创建网络请求接口实例"><a href="#创建网络请求接口实例" class="headerlink" title="创建网络请求接口实例"></a>创建网络请求接口实例</h3><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-comment">// 创建 网络请求接口 的实例</span><br>        GetRequest_Interface request = retrofit.create(GetRequest_Interface.<span class="hljs-keyword">class</span>);<br><br>        <span class="hljs-comment">//对 发送请求 进行封装</span><br>        <span class="hljs-keyword">Call</span>&lt;Reception&gt; <span class="hljs-keyword">call</span> = request.getCall();<br></code></pre></td></tr></table></figure>
<h3 id="发送网络请求"><a href="#发送网络请求" class="headerlink" title="发送网络请求"></a>发送网络请求</h3><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs gradle">/发送网络请求(异步)<br>        <span class="hljs-keyword">call</span>.enqueue(<span class="hljs-keyword">new</span> Callback&lt;Translation&gt;() &#123;<br>            <span class="hljs-comment">//请求成功时回调</span><br>            @Override<br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> onResponse(<span class="hljs-keyword">Call</span>&lt;Translation&gt; <span class="hljs-keyword">call</span>, Response&lt;Translation&gt; response) &#123;<br>                <span class="hljs-comment">//请求处理,输出结果</span><br>                response.body().show();<br>            &#125;<br><br>            <span class="hljs-comment">//请求失败时候的回调</span><br>            @Override<br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> onFailure(<span class="hljs-keyword">Call</span>&lt;Translation&gt; <span class="hljs-keyword">call</span>, Throwable throwable) &#123;<br>                System.out.<span class="hljs-keyword">println</span>(<span class="hljs-string">&quot;连接失败&quot;</span>);<br>            &#125;<br>        &#125;);<br><br><span class="hljs-comment">// 发送网络请求（同步）</span><br>Response&lt;Reception&gt; response = <span class="hljs-keyword">call</span>.execute();<br></code></pre></td></tr></table></figure>
<h3 id="数据返回处理"><a href="#数据返回处理" class="headerlink" title="数据返回处理"></a>数据返回处理</h3><p>在response类中的body()里处理</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-comment">//发送网络请求(异步)</span><br>        <span class="hljs-keyword">call</span>.enqueue(<span class="hljs-keyword">new</span> Callback&lt;Translation&gt;() &#123;<br>            <span class="hljs-comment">//请求成功时回调</span><br>            @Override<br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> onResponse(<span class="hljs-keyword">Call</span>&lt;Translation&gt; <span class="hljs-keyword">call</span>, Response&lt;Translation&gt; response) &#123;<br>                <span class="hljs-comment">// 对返回数据进行处理</span><br>                response.body().show();<br>            &#125;<br><br>            <span class="hljs-comment">//请求失败时候的回调</span><br>            @Override<br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> onFailure(<span class="hljs-keyword">Call</span>&lt;Translation&gt; <span class="hljs-keyword">call</span>, Throwable throwable) &#123;<br>                System.out.<span class="hljs-keyword">println</span>(<span class="hljs-string">&quot;连接失败&quot;</span>);<br>            &#125;<br>        &#125;);<br><br><span class="hljs-comment">// 发送网络请求（同步）</span><br>  Response&lt;Reception&gt; response = <span class="hljs-keyword">call</span>.execute();<br>  <span class="hljs-comment">// 对返回数据进行处理</span><br>  response.body().show();<br></code></pre></td></tr></table></figure>
<p>在开发中我们一般会使用RxJava和Retrofit，以及Gson完成网络请求的基本操作，以后再写</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><blockquote>
<p>尊重他人劳动成果，也是对自己的尊重</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="http://blog.csdn.net/carson_ho/article/details/52171976">Android主流网络请求开源库的对比</a><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/u012124438/article/details/54236967">深入解析OkHttp3</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/android/">#android</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>重拾android路(三) 网络请求</div>
      <div>http://example.com/2016/02/19/Android-3-network/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>John Doe</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2016年2月19日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2016/02/29/android-4-json/" title="重拾Android路(四) json解析">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">重拾Android路(四) json解析</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2016/01/09/Android-2-adaptation/" title="重拾android路(二) 手机适配">
                        <span class="hidden-mobile">重拾android路(二) 手机适配</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
